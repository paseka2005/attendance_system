<!DOCTYPE html>
<html>
<head>
    <title>–ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .panel { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #4CAF50; color: white; }
        .present { background: #d4edda; }
        .absent { background: #f8d7da; }
        .late { background: #fff3cd; }
        button, select, input { padding: 8px 15px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        .qr-img { max-width: 200px; margin: 10px 0; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h1>
        
        <!-- –ü–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è -->
        <div class="panel">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ</h2>
            <form id="createClassForm">
                <input type="text" name="subject" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" required>
                <input type="datetime-local" name="date_time" required>
                <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
            </form>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π -->
        <div class="panel">
            <h2>–ó–∞–Ω—è—Ç–∏—è</h2>
            <div id="classesList">
                {% for class in classes %}
                <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <strong>{{ class.subject }}</strong> - {{ class.date_time }}
                    <button onclick="generateQR({{ class.id }})">QR-–∫–æ–¥</button>
                    <button onclick="loadAttendance({{ class.id }})">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
                    <a href="/api/export_csv/{{ class.id }}"><button>CSV</button></a>
                    <div id="qr_{{ class.id }}"></div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ -->
        <div class="panel">
            <h2>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å <span id="classTitle"></span></h2>
            <table>
                <thead>
                    <tr>
                        <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                        <th>–ì—Ä—É–ø–ø–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ò–∑–º–µ–Ω–∏—Ç—å</th>
                    </tr>
                </thead>
                <tbody id="attendanceTable">
                    {% for student in attendance %}
                    <tr class="{{ student.status }}">
                        <td>{{ student.name }}</td>
                        <td>{{ student.group_name }}</td>
                        <td>{{ student.status }}</td>
                        <td>
                            <select onchange="updateStatus({{ student.id }}, this.value)">
                                <option value="present" {% if student.status == 'present' %}selected{% endif %}>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                                <option value="absent" {% if student.status == 'absent' %}selected{% endif %}>–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                                <option value="late" {% if student.status == 'late' %}selected{% endif %}>–û–ø–æ–∑–¥–∞–ª</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
        <div class="panel" style="background: #e8f4f8;">
            <h2>üì± –î–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
            <p>–°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏:</p>
            <input type="text" id="studentLink" value="{{ request.host_url }}scan" readonly style="width: 400px; padding: 10px;">
            <button onclick="copyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞–º –∏–ª–∏ –ø–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥
            </p>
        </div>
    </div>
    
    <script>
        const selectedClassId = {{ selected_class }};
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏—è
        document.getElementById('createClassForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const response = await fetch('/api/create_class', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                alert('–ó–∞–Ω—è—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
                location.reload();
            }
        };
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
        function generateQR(classId) {
            const qrDiv = document.getElementById(`qr_${classId}`);
            qrDiv.innerHTML = `<img src="/api/generate_qr/${classId}" class="qr-img" alt="QR Code">`;
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
        async function loadAttendance(classId) {
            const response = await fetch(`/api/get_attendance/${classId}`);
            const attendance = await response.json();
            
            const tbody = document.getElementById('attendanceTable');
            tbody.innerHTML = '';
            
            attendance.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = student.status;
                tr.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.group_name}</td>
                    <td>${student.status}</td>
                    <td>
                        <select onchange="updateStatus(${student.id}, this.value)">
                            <option value="present" ${student.status === 'present' ? 'selected' : ''}>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                            <option value="absent" ${student.status === 'absent' ? 'selected' : ''}>–û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª</option>
                            <option value="late" ${student.status === 'late' ? 'selected' : ''}>–û–ø–æ–∑–¥–∞–ª</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('classTitle').textContent = '(–¢–µ–∫—É—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ)';
        }
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(studentId, status) {
            fetch('/api/update_status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    student_id: studentId,
                    class_id: selectedClassId,
                    status: status
                })
            });
            
            // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏
            event.target.closest('tr').className = status;
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
        function copyLink() {
            const linkInput = document.getElementById('studentLink');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value);
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }
    </script>
</body>
</html>